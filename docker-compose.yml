services:
  caddy:
    image: caddy:latest
    container_name: ghost_caddy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN:?DOMAIN environment variable is required}
      ADMIN_DOMAIN: ${ADMIN_DOMAIN:-}
      ACTIVITYPUB_TARGET: ${ACTIVITYPUB_TARGET:-https://ap.ghost.org}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - ghost
    networks:
      - ghost_network
  redis:
    image: redis:latest
    container_name: ghost_redis
    restart: unless-stopped
    expose:
      - "6379"
    deploy:
      resources:
        limits:
          memory: 512m
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    volumes:
      - redis_cache:/data
    networks:
      - ghost_network

  ghost:
    build: .
    container_name: ghost_oci
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
    depends_on:
      redis:
        condition: service_healthy
    expose:
      - "2368"    
    ports:
      - "2368:2368"
    environment:
      # url: http://mylocalai.mikhailidi.me:2368
      NODE_ENV: development
      logging__level: "trace"
      security__staffDeviceVerification: 'false'
      adapters__cache__imageSizes__adapter: "Redis"
      adapters__cache__imageSizes__ttl: 3600
      adapters__cache__imageSizes__keyPrefix: "image-sizes:"
      adapters__cache__imageSizes__host: "redis"
      adapters__cache__imageSizes__port: 6379
      storage__active: "oci"
      storage__oci__tenancy: "${GHOST_STORAGE_ADAPTER_OCI_TENANCY}"
      storage__oci__user: "${GHOST_STORAGE_ADAPTER_OCI_USER}"
      storage__oci__compartmentId: ${GHOST_STORAGE_ADAPTER_OCI_COMPARTMENT}
      storage__oci__bucket: "${GHOST_STORAGE_ADAPTER_OCI_BUCKET}"
      storage__oci__region: "${GHOST_STORAGE_ADAPTER_OCI_REGION}"
      storage__oci__namespace: "${GHOST_STORAGE_ADAPTER_OCI_NAMESPACE}" 
      storage__oci__fingerprint: "${GHOST_STORAGE_ADAPTER_OCI_FINGERPRINT}"
      storage__oci__privateKey: "${GHOST_STORAGE_ADAPTER_OCI_PKEY}"
      storage__oci__pathPrefix: "${GHOST_STORAGE_ADAPTER_OCI_PATH_PREFIX}"
    volumes:
      - ghost_content:/var/lib/ghost/content
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2368/"]
      interval: 2m
      timeout: 20s
      retries: 5  
networks:
  ghost_network:

volumes: 
  redis_cache:
  caddy_data:
  caddy_config:
  ghost_content:


